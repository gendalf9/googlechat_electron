<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Chat Desktop</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #fff;
        overflow: hidden;
      }

      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.3s ease;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e3f2fd;
        border-top: 3px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: #5f6368;
        font-size: 14px;
        margin-top: 10px;
      }

      .loading-subtitle {
        color: #80868b;
        font-size: 12px;
        margin-top: 5px;
      }

      #error-message {
        display: none;
        text-align: center;
        padding: 40px;
        color: #5f6368;
      }

      #error-message h2 {
        color: #d93025;
        margin-bottom: 10px;
      }

      .retry-button {
        background: #1976d2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
        transition: background-color 0.2s ease;
      }

      .retry-button:hover {
        background: #1565c0;
      }

      .retry-button:active {
        background: #0d47a1;
      }

      /* 성능 최적화를 위한 스타일 */
      * {
        box-sizing: border-box;
      }

      /* GPU 가속 */
      #loading,
      .spinner {
        will-change: opacity, transform;
        transform: translateZ(0);
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Google Chat을 로드하는 중...</div>
      <div class="loading-subtitle">최적화된 성능으로 더 빠르게</div>
    </div>

    <div id="error-message">
      <h2>연결 오류</h2>
      <p>Google Chat을 로드할 수 없습니다.</p>
      <p>인터넷 연결을 확인하고 다시 시도해주세요.</p>
      <button class="retry-button" onclick="retryLoading()">다시 시도</button>
    </div>

    <script>
      // 성능 측정 시작
      if (window.performance && window.performance.mark) {
        window.performance.mark('html-load-start');
      }

      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('error-message');
      let retryCount = 0;
      const maxRetries = 3;

      // 최적화된 Google Chat 로드 함수
      function loadGoogleChat() {
        console.log(`Loading Google Chat (attempt ${retryCount + 1})`);

        // 로딩 메시지 업데이트
        if (retryCount > 0) {
          document.querySelector('.loading-subtitle').textContent =
            `다시 시도 중... (${retryCount}/${maxRetries})`;
        }

        // BrowserWindow를 사용하므로 직접 페이지 로드가 아님
        // main.js에서 처리함
        setTimeout(() => {
          hideLoading();
        }, 2000); // 2초 후 로딩 화면 숨김
      }

      function hideLoading() {
        loading.style.opacity = '0';
        setTimeout(() => {
          loading.style.display = 'none';
        }, 300);
      }

      function showError() {
        loading.style.display = 'none';
        errorMessage.style.display = 'block';
      }

      function retryLoading() {
        if (retryCount >= maxRetries) {
          document.querySelector('.loading-subtitle').textContent =
            '최대 재시도 횟수를 초과했습니다.';
          return;
        }

        retryCount++;
        errorMessage.style.display = 'none';
        loading.style.display = 'flex';

        loadGoogleChat();
      }

      // 성능 모니터링 제거 (CPU 절약)

      // 초기화
      document.addEventListener('DOMContentLoaded', () => {
        console.log('HTML loaded, preparing app');

        // Electron API 확인
        if (window.electronAPI) {
          console.log('Electron API available');
          console.log('App version:', window.electronAPI.getAppVersion());
          console.log('Platform:', window.electronAPI.getPlatform());
        } else {
          console.warn('Electron API not available');
        }

        // Google Chat 로드 시작
        setTimeout(() => {
          loadGoogleChat();
        }, 500);
      });

      // 페이지 로드 완료
      window.addEventListener('load', () => {
        if (window.performance && window.performance.mark) {
          window.performance.mark('html-load-end');
          window.performance.measure('html-loading', 'html-load-start', 'html-load-end');

          const measures = window.performance.getEntriesByName('html-loading');
          if (measures.length > 0) {
            console.log(`HTML loaded in ${measures[0].duration}ms`);
          }
        }

        // 성능 모니터링 제거됨
      });

      // 키보드 이벤트 핸들링 (fallback)
      document.addEventListener('keydown', e => {
        // Electron API가 없을 때의 기본 동작
        if (!window.electronAPI) {
          if ((e.metaKey || e.ctrlKey) && e.key === 'r') {
            e.preventDefault();
            window.location.reload();
          }
        }
      });

      // 에러 핸들링
      window.addEventListener('error', e => {
        console.error('HTML Error:', e.error);

        // 네트워크 에러인 경우 재시도
        if (e.message.includes('net::') || e.message.includes('Network')) {
          if (retryCount < maxRetries) {
            setTimeout(retryLoading, 2000);
          } else {
            showError();
          }
        }
      });

      // 언로드 시 정리
      window.addEventListener('beforeunload', () => {
        console.log('HTML unloading - cleaning up');

        // 성능 측정 정리
        if (window.performance && window.performance.clearMarks) {
          window.performance.clearMarks();
          window.performance.clearMeasures();
        }
      });

      // 메모리 모니터링 제거 (CPU 절약)
    </script>
  </body>
</html>
